=== CONTROLLERS CR√çTICOS ===

=========================================
FILE: app/Modules/Assinatura/Controllers/AssinaturaController.php
=========================================
<?php

namespace App\Modules\Assinatura\Controllers;

use App\Http\Controllers\Api\BaseApiController;
use App\Http\Controllers\Traits\HasAuthContext;
use App\Application\Assinatura\UseCases\BuscarAssinaturaAtualUseCase;
use App\Application\Assinatura\UseCases\ObterStatusAssinaturaUseCase;
use App\Application\Assinatura\UseCases\ListarAssinaturasUseCase;
use App\Application\Assinatura\UseCases\CancelarAssinaturaUseCase;
use App\Application\Assinatura\UseCases\CriarAssinaturaUseCase;
use App\Application\Assinatura\UseCases\TrocarPlanoAssinaturaUseCase;
use App\Application\Assinatura\UseCases\BuscarTenantDoUsuarioUseCase;
use App\Application\Assinatura\DTOs\CriarAssinaturaDTO;
use App\Application\Assinatura\Resources\AssinaturaResource;
use App\Application\Payment\UseCases\RenovarAssinaturaUseCase;
use App\Domain\Assinatura\Repositories\AssinaturaRepositoryInterface;
use App\Domain\Payment\Repositories\PaymentProviderInterface;
use App\Http\Requests\Assinatura\RenovarAssinaturaRequest;
use App\Http\Requests\Assinatura\CriarAssinaturaRequest;
use App\Http\Requests\Assinatura\TrocarPlanoRequest;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;

/**
 * Controller para Assinaturas
 * 
 * Refatorado para seguir DDD rigorosamente:
 * - Usa Form Requests para valida√ß√£o
 * - Usa Use Cases para l√≥gica de neg√≥cio
 * - Usa Resources para transforma√ß√£o
 * - N√£o acessa modelos Eloquent diretamente
 * - N√£o cont√©m l√≥gica de infraestrutura (cache, etc.)
 * 
 * Segue o mesmo padr√£o do OrgaoController:
 * - Tenant ID: Obtido automaticamente via tenancy()->tenant (middleware j√° inicializou)
 * - Empresa ID: Obtido automaticamente via getEmpresaAtivaOrFail() que prioriza header X-Empresa-ID
 */
class AssinaturaController extends BaseApiController
{
    use HasAuthContext;

    public function __construct(
        private BuscarAssinaturaAtualUseCase $buscarAssinaturaAtualUseCase,
        private ObterStatusAssinaturaUseCase $obterStatusAssinaturaUseCase,
        private ListarAssinaturasUseCase $listarAssinaturasUseCase,
        private CancelarAssinaturaUseCase $cancelarAssinaturaUseCase,
        private CriarAssinaturaUseCase $criarAssinaturaUseCase,
        private TrocarPlanoAssinaturaUseCase $trocarPlanoAssinaturaUseCase,
        private RenovarAssinaturaUseCase $renovarAssinaturaUseCase,
        private BuscarTenantDoUsuarioUseCase $buscarTenantDoUsuarioUseCase,
        private PaymentProviderInterface $paymentProvider,
        private AssinaturaResource $assinaturaResource,
        private AssinaturaRepositoryInterface $assinaturaRepository,
    ) {}



    /**
     * Retorna assinatura atual do USU√ÅRIO
     * Retorna entidade de dom√≠nio transformada via Resource
     * 
     * ‚úÖ O QUE O CONTROLLER FAZ:
     * - Recebe request
     * - Obt√©m usu√°rio autenticado
     * - Busca tenant baseado na empresa ativa do USU√ÅRIO
     * - Chama Use Case para buscar assinatura
     * - Transforma entidade em DTO de resposta
     * 
     * ‚ùå O QUE O CONTROLLER N√ÉO FAZ:
     * - N√£o l√™ tenant_id diretamente do header
     * - N√£o usa tenant do contexto sem validar
     * - A valida√ß√£o √© baseada no USU√ÅRIO, n√£o no tenant/empresa do header
     * 
     * üî• IMPORTANTE: A assinatura √© validada pelo USU√ÅRIO, n√£o pelo tenant/empresa.
     * Busca o tenant onde a empresa ativa do usu√°rio est√°.
     * Permite acesso mesmo sem assinatura (retorna null) para que o frontend possa tratar.
     */
    public function atual(Request $request): JsonResponse
    {
        try {
            // Obter usu√°rio autenticado (fonte de verdade)
            $user = $this->getUserOrFail();
            
            // Buscar tenant baseado na empresa ativa do USU√ÅRIO
            $tenant = $this->buscarTenantDoUsuarioUseCase->executar($user);
            
            if (!$tenant) {
                \Log::warning('AssinaturaController::atual() - N√£o foi poss√≠vel determinar tenant do usu√°rio', [
                    'user_id' => $user->id,
                    'empresa_ativa_id' => $user->empresa_ativa_id,
                ]);
                
                return response()->json([
                    'data' => null,
                    'message' => 'Nenhuma assinatura encontrada',
                    'code' => 'NO_SUBSCRIPTION'
                ], 200);
            }

            // üî• CR√çTICO: Verificar se usu√°rio tem empresa ativa
            if (!$user->empresa_ativa_id) {
                \Log::warning('AssinaturaController::atual() - Usu√°rio n√£o tem empresa ativa', [
                    'user_id' => $user->id,
                ]);
                
                return response()->json([
                    'data' => null,
                    'message' => 'Nenhuma empresa ativa encontrada. Selecione uma empresa para ver a assinatura.',
                    'code' => 'NO_ACTIVE_COMPANY'
                ], 200);
            }

            \Log::info('AssinaturaController@atual - Buscando assinatura da empresa', [
                'user_id' => $user->id,
                'empresa_ativa_id' => $user->empresa_ativa_id,
                'tenant_id' => $tenant->id,
            ]);
            
            // üî• CORRIGIDO: Buscar assinatura da EMPRESA ATIVA do usu√°rio, n√£o do usu√°rio
            // A assinatura pertence √† empresa, n√£o ao usu√°rio
            try {
                $assinatura = $this->assinaturaRepository->buscarAssinaturaAtualPorEmpresa($user->empresa_ativa_id);
                
                if (!$assinatura) {
                    \Log::info('AssinaturaController@atual - Nenhuma assinatura encontrada para a empresa', [
                        'empresa_ativa_id' => $user->empresa_ativa_id,
                    ]);
                    
                    return response()->json([
                        'data' => null,
                        'message' => 'Nenhuma assinatura encontrada para esta empresa',
                        'code' => 'NO_SUBSCRIPTION'
                    ], 200);
                }
                
                // Transformar entidade do dom√≠nio em DTO de resposta
                $responseDTO = $this->assinaturaResource->toResponse($assinatura);

                \Log::info('AssinaturaController@atual - Assinatura encontrada', [
                    'assinatura_id' => $assinatura->id,
                    'empresa_id' => $assinatura->empresaId,
                    'status' => $assinatura->status,
                ]);

                return response()->json([
                    'data' => $responseDTO->toArray()
                ]);
            } catch (\App\Domain\Exceptions\NotFoundException $e) {
                // N√£o h√° assinatura - retornar null para que o frontend possa tratar
                \Log::info('AssinaturaController@atual - NotFoundException capturada', [
                    'empresa_ativa_id' => $user->empresa_ativa_id,
                    'message' => $e->getMessage(),
                ]);
                
                return response()->json([
                    'data' => null,
                    'message' => 'Nenhuma assinatura encontrada para esta empresa',
                    'code' => 'NO_SUBSCRIPTION'
                ], 200);
            }
        } catch (\Exception $e) {
            return $this->handleException($e, 'Erro ao buscar assinatura atual');
        }
    }
    

    /**
     * Retorna status da assinatura com limites utilizados
     * Retorna dados de status e limites utilizados
     * 
     * ‚úÖ O QUE O CONTROLLER FAZ:
     * - Recebe request
     * - Obt√©m usu√°rio autenticado
     * - Busca tenant baseado na empresa ativa do USU√ÅRIO
     * - Obt√©m empresa automaticamente via getEmpresaAtivaOrFail()
     * - Chama Use Case para obter status
     * - Retorna dados de status e limites
     * 
     * ‚ùå O QUE O CONTROLLER N√ÉO FAZ:
     * - N√£o l√™ tenant_id diretamente do header
     * - N√£o usa tenant do contexto sem validar
     * - A valida√ß√£o √© baseada no USU√ÅRIO, n√£o no tenant/empresa do header
     * 
     * üî• IMPORTANTE: A assinatura √© validada pelo USU√ÅRIO, n√£o pelo tenant/empresa.
     * Permite acesso mesmo sem assinatura (retorna null) para que o frontend possa tratar.
     */
    public function status(Request $request): JsonResponse
    {
        try {
            // Obter usu√°rio autenticado (fonte de verdade)
            $user = $this->getUserOrFail();
            
            // Buscar tenant baseado na empresa ativa do USU√ÅRIO
            $tenant = $this->buscarTenantDoUsuarioUseCase->executar($user);
            
            if (!$tenant) {
                \Log::warning('AssinaturaController::status() - N√£o foi poss√≠vel determinar tenant do usu√°rio', [
                    'user_id' => $user->id,
                    'empresa_ativa_id' => $user->empresa_ativa_id,


=========================================
FILE: app/Modules/Assinatura/Controllers/PlanoController.php
=========================================
<?php

namespace App\Modules\Assinatura\Controllers;

use App\Http\Controllers\Api\BaseApiController;
use App\Application\Plano\UseCases\ListarPlanosUseCase;
use App\Application\Plano\UseCases\BuscarPlanoUseCase;
use App\Domain\Plano\Repositories\PlanoRepositoryInterface;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\Log;

/**
 * Controller para gerenciamento de Planos
 * 
 * Refatorado para seguir DDD rigorosamente:
 * - Usa Use Cases para l√≥gica de neg√≥cio
 * - Usa Repository para acesso a dados
 * - N√£o acessa modelos Eloquent diretamente
 * - N√£o cont√©m l√≥gica de infraestrutura (cache, etc.)
 * 
 * Rotas p√∫blicas - podem ser visualizadas sem autentica√ß√£o
 * N√£o requer tenant ou empresa (planos s√£o globais)
 * 
 * Segue o mesmo padr√£o do OrgaoController:
 * - N√£o precisa de tenant_id (planos s√£o globais)
 * - N√£o precisa de empresa_id (planos s√£o globais)
 */
class PlanoController extends BaseApiController
{
    public function __construct(
        private ListarPlanosUseCase $listarPlanosUseCase,
        private BuscarPlanoUseCase $buscarPlanoUseCase,
        private PlanoRepositoryInterface $planoRepository,
    ) {}

    /**
     * Lista todos os planos ativos
     * Retorna entidades de dom√≠nio transformadas
     * 
     * ‚úÖ O QUE O CONTROLLER FAZ:
     * - Recebe request
     * - Aplica filtros opcionais
     * - Chama Use Case para listar
     * - Transforma entidades em arrays
     * 
     * ‚ùå O QUE O CONTROLLER N√ÉO FAZ:
     * - N√£o l√™ tenant_id (planos s√£o globais)
     * - N√£o acessa Tenant (planos s√£o globais)
     * - N√£o filtra por empresa (planos s√£o globais)
     * 
     * GET /api/v1/planos
     */
    public function list(Request $request): JsonResponse
    {
        Log::info('üîç PlanoController::list - Iniciando listagem de planos', [
            'path' => $request->path(),
            'method' => $request->method(),
            'query_params' => $request->query(),
            'headers' => $request->headers->all(),
        ]);

        try {
            // Preparar filtros
            $filtros = [];
            
            // Aplicar filtros se necess√°rio
            if ($request->has('ativo')) {
                $filtros['ativo'] = $request->boolean('ativo');
            }

            Log::info('üîç PlanoController::list - Filtros preparados', [
                'filtros' => $filtros,
            ]);

            // Executar Use Case (retorna entidades de dom√≠nio)
            Log::info('üîç PlanoController::list - Chamando ListarPlanosUseCase::executar');
            $planosDomain = $this->listarPlanosUseCase->executar($filtros);

            Log::info('üîç PlanoController::list - UseCase retornou planos domain', [
                'count' => $planosDomain->count(),
                'ids' => $planosDomain->pluck('id')->toArray(),
            ]);

            // Converter entidades de dom√≠nio para modelos Eloquent para manter compatibilidade com frontend
            Log::info('üîç PlanoController::list - Convertendo entidades para modelos Eloquent');
            $planos = $planosDomain->map(function ($planoDomain) {
                $modelo = $this->planoRepository->buscarModeloPorId($planoDomain->id);
                Log::debug('üîç PlanoController::list - Convertendo plano', [
                    'domain_id' => $planoDomain->id,
                    'modelo_encontrado' => $modelo !== null,
                ]);
                return $modelo;
            })->filter(); // Remove nulls

            Log::info('üîç PlanoController::list - Convers√£o conclu√≠da', [
                'planos_count' => $planos->count(),
                'planos_ids' => $planos->pluck('id')->toArray(),
            ]);

            $response = [
                'data' => $planos->values()->all(),
                'meta' => [
                    'total' => $planos->count(),
                ],
            ];

            Log::info('‚úÖ PlanoController::list - Retornando resposta', [
                'total' => $planos->count(),
                'response_keys' => array_keys($response),
            ]);

            return response()->json($response);
        } catch (\Exception $e) {
            Log::error('‚ùå PlanoController::list - Erro ao listar planos', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'file' => $e->getFile(),
                'line' => $e->getLine(),
            ]);
            return $this->handleException($e, 'Erro ao listar planos');
        }
    }

    /**
     * Busca um plano espec√≠fico por ID
     * Retorna entidade de dom√≠nio transformada
     * 
     * ‚úÖ O QUE O CONTROLLER FAZ:
     * - Recebe request
     * - Chama Use Case para buscar
     * - Transforma entidade em array
     * 
     * ‚ùå O QUE O CONTROLLER N√ÉO FAZ:
     * - N√£o l√™ tenant_id (planos s√£o globais)
     * - N√£o acessa Tenant (planos s√£o globais)
     * - N√£o filtra por empresa (planos s√£o globais)
     * 
     * GET /api/v1/planos/{plano}
     */
    public function get(Request $request, int $plano): JsonResponse
    {
        try {
            // Executar Use Case
            $planoDomain = $this->buscarPlanoUseCase->executar($plano);
            
            // Buscar modelo Eloquent para resposta (mant√©m compatibilidade com frontend)
            $planoModel = $this->planoRepository->buscarModeloPorId($planoDomain->id);

            if (!$planoModel) {
                return response()->json([
                    'message' => 'Plano n√£o encontrado'
                ], 404);
            }

            return response()->json([
                'data' => $planoModel
            ]);
        } catch (\App\Domain\Exceptions\NotFoundException $e) {
            return response()->json([
                'message' => $e->getMessage()
            ], 404);
        } catch (\Exception $e) {
            return $this->handleException($e, 'Erro ao buscar plano');
        }
    }
}



=========================================
FILE: app/Http/Controllers/Admin/AdminAssinaturaController.php
=========================================
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Http\Responses\ApiResponse;
use App\Application\Assinatura\UseCases\ListarAssinaturasAdminUseCase;
use App\Application\Assinatura\UseCases\BuscarAssinaturaAdminUseCase;
use App\Application\Assinatura\UseCases\AtualizarAssinaturaAdminUseCase;
use App\Application\Assinatura\UseCases\CriarAssinaturaAdminUseCase;
use App\Application\Tenant\UseCases\ListarTenantsParaFiltroUseCase;
use App\Http\Requests\Assinatura\AtualizarAssinaturaAdminRequest;
use App\Http\Requests\Admin\TrocarPlanoAssinaturaAdminRequest;
use App\Http\Requests\Admin\StoreAssinaturaAdminRequest;
use App\Models\Tenant;
use App\Modules\Assinatura\Models\Assinatura;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

/**
 * Controller Admin para gerenciar assinaturas de todos os tenants
 * 
 * 100% DDD - Apenas recebe request e delega para Use Cases
 * 
 * Padr√£o similar ao OrgaoController:
 * - M√©todos auxiliares para extrair IDs da rota
 * - M√©todos handle* que recebem IDs diretamente
 * - M√©todos p√∫blicos que podem usar Route Model Binding ou extrair IDs
 */
class AdminAssinaturaController extends Controller
{
    public function __construct(
        private ListarAssinaturasAdminUseCase $listarAssinaturasAdminUseCase,
        private BuscarAssinaturaAdminUseCase $buscarAssinaturaAdminUseCase,
        private AtualizarAssinaturaAdminUseCase $atualizarAssinaturaAdminUseCase,
        private CriarAssinaturaAdminUseCase $criarAssinaturaAdminUseCase,
        private ListarTenantsParaFiltroUseCase $listarTenantsParaFiltroUseCase,
    ) {}

    /**
     * Extrai o tenant_id da rota
     * Padr√£o similar ao OrgaoController::getRouteId()
     */
    protected function getTenantIdFromRoute($route): ?int
    {
        $parameters = $route->parameters();
        // Tentar 'tenantId' primeiro, depois 'tenant', depois 'id'
        $id = $parameters['tenantId'] ?? $parameters['tenant'] ?? $parameters['id'] ?? null;
        return $id ? (int) $id : null;
    }

    /**
     * Extrai o assinatura_id da rota
     * Padr√£o similar ao OrgaoController::getRouteId()
     */
    protected function getAssinaturaIdFromRoute($route): ?int
    {
        $parameters = $route->parameters();
        // Tentar 'assinaturaId' primeiro, depois 'assinatura', depois 'id'
        $id = $parameters['assinaturaId'] ?? $parameters['assinatura'] ?? $parameters['id'] ?? null;
        return $id ? (int) $id : null;
    }

    /**
     * Listar todas as assinaturas de todos os tenants
     */
    public function index(Request $request)
    {
        try {
            $filtros = [
                'tenant_id' => $request->tenant_id,
                'status' => $request->status,
                'search' => $request->search,
            ];

            // Executar Use Case
            $todasAssinaturas = $this->listarAssinaturasAdminUseCase->executar($filtros);

            // Pagina√ß√£o manual
            $perPage = $request->per_page ?? 15;
            $currentPage = $request->page ?? 1;
            $total = $todasAssinaturas->count();
            $offset = ($currentPage - 1) * $perPage;
            $paginated = $todasAssinaturas->slice($offset, $perPage)->values();

            // Criar paginator manual (UseCase retorna Collection, n√£o Paginator)
            $paginator = new \Illuminate\Pagination\LengthAwarePaginator(
                $paginated,
                $total,
                $perPage,
                $currentPage,
                [
                    'path' => $request->url(),
                    'pageName' => 'page',
                ]
            );

            return ApiResponse::paginated($paginator);
        } catch (\Exception $e) {
            Log::error('Erro ao listar assinaturas', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
            ]);
            return ApiResponse::error('Erro ao listar assinaturas.', 500);
        }
    }

    /**
     * M√©todo handleGet - recebe IDs diretamente
     * Padr√£o similar ao OrgaoController::handleGet()
     */
    protected function handleGet(Request $request, array $mergeParams = []): \Illuminate\Http\JsonResponse
    {
        $route = $request->route();
        $tenantId = $this->getTenantIdFromRoute($route);
        $assinaturaId = $this->getAssinaturaIdFromRoute($route);
        
        if (!$tenantId || !$assinaturaId) {
            return ApiResponse::error('Tenant ID ou Assinatura ID n√£o fornecido', 400);
        }

        try {
            // Executar Use Case
            $data = $this->buscarAssinaturaAdminUseCase->executar($tenantId, $assinaturaId);

            return ApiResponse::item($data);
        } catch (\App\Domain\Exceptions\NotFoundException $e) {
            return ApiResponse::error($e->getMessage(), 404);
        } catch (\Exception $e) {
            Log::error('Erro ao buscar assinatura', [
                'error' => $e->getMessage(),
                'tenant_id' => $tenantId,
                'assinatura_id' => $assinaturaId,
            ]);
            return ApiResponse::error('Erro ao buscar assinatura.', 500);
        }
    }

    /**
     * M√©todo p√∫blico - pode usar Route Model Binding ou extrair IDs da rota
     * Padr√£o similar ao OrgaoController::show()
     * 
     * Suporta duas formas:
     * 1. Route Model Binding: show(Request $request, Tenant $tenant, Assinatura $assinatura)
     * 2. IDs num√©ricos: show(Request $request, int $tenantId, int $assinaturaId)
     */
    public function show(Request $request, Tenant|int $tenantOrId, Assinatura|int $assinaturaOrId = null)
    {
        // Se os modelos foram injetados via Route Model Binding, usar os IDs deles
        if ($tenantOrId instanceof Tenant && $assinaturaOrId instanceof Assinatura) {
            $request->route()->setParameter('tenantId', $tenantOrId->id);
            $request->route()->setParameter('assinaturaId', $assinaturaOrId->id);
        } elseif (is_int($tenantOrId) && is_int($assinaturaOrId)) {
            // Se s√£o IDs num√©ricos, definir nos par√¢metros da rota
            $request->route()->setParameter('tenantId', $tenantOrId);
            $request->route()->setParameter('assinaturaId', $assinaturaOrId);
        }
        
        return $this->handleGet($request);
    }

    /**
     * M√©todo handleUpdate - recebe IDs diretamente
     * Padr√£o similar ao OrgaoController::handleUpdate()
     */
    protected function handleUpdate(AtualizarAssinaturaAdminRequest $request, int|string $tenantId, int|string $assinaturaId, array $mergeParams = []): \Illuminate\Http\JsonResponse
    {
        try {
            // Request j√° est√° validado via Form Request
            $validated = $request->validated();

            // Garantir que s√£o inteiros
            $tenantId = (int) $tenantId;
            $assinaturaId = (int) $assinaturaId;

            // Executar Use Case
            $assinaturaDomain = $this->atualizarAssinaturaAdminUseCase->executar($tenantId, $assinaturaId, $validated);

            // Buscar modelo para resposta
            $assinaturaModel = $this->buscarAssinaturaAdminUseCase->executar($tenantId, $assinaturaId);

            return ApiResponse::success(
                'Assinatura atualizada com sucesso',
                $assinaturaModel
            );
        } catch (\App\Domain\Exceptions\NotFoundException $e) {
            return ApiResponse::error($e->getMessage(), 404);
        } catch (\App\Domain\Exceptions\DomainException $e) {
            return ApiResponse::error($e->getMessage(), 400);
        } catch (\Exception $e) {
            Log::error('Erro ao atualizar assinatura', [
                'error' => $e->getMessage(),
                'tenant_id' => $tenantId,
                'assinatura_id' => $assinaturaId,
                'trace' => $e->getTraceAsString(),
            ]);
            return ApiResponse::error('Erro ao atualizar assinatura.', 500);
        }
    }



